import{aA as E,j as c,av as L,aj as f,al as h,aB as p,l as y,e as m,as as G,at as g,an as l,aC as S,ac as w,aD as b,aE as M,i as N,aF as $}from"./vidstack-1H0xyD-V-GsgDWWA0.js";import{VideoProvider as R}from"./vidstack-video-SWcsJB0z.js";import{R as I}from"./vidstack-2gN4S9Em-so2c80n4.js";import"./app-1YKN_eT2.js";const O=o=>$(o);class _{constructor(t){this.Ga=null,this.Ha=null,this.P={},this.Q=new Set,this.ya=t}get instance(){return this.Ga}setup(t,i){this.d=i;const e=f(i.$state.streamType).includes("live"),a=f(i.$state.streamType).includes("ll-");this.Ga=new t({lowLatencyMode:a,backBufferLength:a?4:e?8:void 0,renderTextTracksNatively:!1,...this.P});const s=this.Ia.bind(this);for(const r of Object.values(t.Events))this.Ga.on(r,s);this.Ga.on(t.Events.ERROR,this.Ja.bind(this));for(const r of this.Q)r(this.Ga);i.player.dispatch(new h("hls-instance",{detail:this.Ga})),this.Ga.attachMedia(this.ya),this.Ga.on(t.Events.AUDIO_TRACK_SWITCHED,this.Ka.bind(this)),this.Ga.on(t.Events.LEVEL_SWITCHED,this.La.bind(this)),this.Ga.on(t.Events.LEVEL_LOADED,this.Ma.bind(this)),this.Ga.on(t.Events.NON_NATIVE_TEXT_TRACKS_FOUND,this.Na.bind(this)),this.Ga.on(t.Events.CUES_PARSED,this.Oa.bind(this)),i.qualities[p.Pa]=this.Qa.bind(this),y(i.qualities,"change",this.Ra.bind(this)),y(i.audioTracks,"change",this.Sa.bind(this)),this.Ha=m(this.Ta.bind(this))}Ta(){if(!this.d.$state.live())return;const t=new I(this.Ua.bind(this));return t.Wa(),t.Xa.bind(t)}Ua(){var t;this.d.$state.liveSyncPosition.set(((t=this.Ga)==null?void 0:t.liveSyncPosition)??1/0)}Ia(t,i){var e;(e=this.d.player)==null||e.dispatch(new h(O(t),{detail:i}))}Na(t,i){const e=new h(t,{detail:i});let a=-1;for(let s=0;s<i.tracks.length;s++){const r=i.tracks[s],n=r.subtitleTrack??r.closedCaptions,u=new G({id:`hls-${r.kind}${s}`,src:n==null?void 0:n.url,label:r.label,language:n==null?void 0:n.lang,kind:r.kind});u[g.Ya]=2,u[g.Za]=()=>{u.mode==="showing"?(this.Ga.subtitleTrack=s,a=s):a===s&&(this.Ga.subtitleTrack=-1,a=-1)},r.default&&u.setMode("showing",e),this.d.textTracks.add(u,e)}}Oa(t,i){const e=this.d.textTracks.getById(`hls-${i.track}`);if(!e)return;const a=new h(t,{detail:i});for(const s of i.cues)s.positionAlign="auto",e.addCue(s,a)}Ka(t,i){const e=this.d.audioTracks[i.id];e&&this.d.audioTracks[l.Va](e,!0,new h(t,{detail:i}))}La(t,i){const e=this.d.qualities[i.level];e&&this.d.qualities[l.Va](e,!0,new h(t,{detail:i}))}Ma(t,i){if(this.d.$state.canPlay())return;const{type:e,live:a,totalduration:s,targetduration:r}=i.details,n=new h(t,{detail:i});this.d.delegate.a("stream-type-change",a?e==="EVENT"&&Number.isFinite(s)&&r>=10?"live:dvr":"live":"on-demand",n),this.d.delegate.a("duration-change",s,n);const u=this.Ga.media;this.Ga.currentLevel===-1&&this.d.qualities[p._a](!0,n);for(const d of this.Ga.audioTracks)this.d.audioTracks[l._]({id:d.id+"",label:d.name,language:d.lang||"",kind:"main"},n);for(const d of this.Ga.levels)this.d.qualities[l._]({width:d.width,height:d.height,codec:d.codecSet,bitrate:d.bitrate},n);u.dispatchEvent(new h("canplay",{trigger:n}))}Ja(t,i){var e,a,s;if(i.fatal)switch(i.type){case"networkError":(e=this.Ga)==null||e.startLoad();break;case"mediaError":(a=this.Ga)==null||a.recoverMediaError();break;default:(s=this.Ga)==null||s.destroy(),this.Ga=null;break}}Qa(){this.Ga&&(this.Ga.currentLevel=-1)}Ra(){const{qualities:t}=this.d;!this.Ga||t.auto||(this.Ga[t.switch+"Level"]=t.selectedIndex,S&&(this.ya.currentTime=this.ya.currentTime))}Sa(){const{audioTracks:t}=this.d;this.Ga&&this.Ga.audioTrack!==t.selectedIndex&&(this.Ga.audioTrack=t.selectedIndex)}R(){var t,i;this.d&&(this.d.qualities[p.Pa]=void 0),(t=this.Ga)==null||t.destroy(),this.Ga=null,(i=this.Ha)==null||i.call(this),this.Ha=null}}class D{constructor(t,i,e){this.$a=t,this.d=i,this.eb=e,this.ab()}async ab(){const t={onLoadStart:this.bb.bind(this),onLoaded:this.cb.bind(this),onLoadError:this.db.bind(this)};let i=await C(this.$a,t);if(w(i)&&!c(this.$a)&&(i=await H(this.$a,t)),!i)return null;if(!i.isSupported()){const e="[vidstack]: `hls.js` is not supported in this environment";return this.d.player.dispatch(new h("hls-unsupported")),this.d.delegate.a("error",{message:e,code:4}),null}return i}bb(){this.d.player.dispatch(new h("hls-lib-load-start"))}cb(t){this.d.player.dispatch(new h("hls-lib-loaded",{detail:t})),this.eb(t)}db(t){const i=b(t);this.d.player.dispatch(new h("hls-lib-load-error",{detail:i})),this.d.delegate.a("error",{message:i.message,code:4})}}async function H(o,t={}){var i,e,a,s,r;if(!w(o)){if((i=t.onLoadStart)==null||i.call(t),o.prototype&&o.prototype!==Function)return(e=t.onLoaded)==null||e.call(t,o),o;try{const n=(a=await o())==null?void 0:a.default;if(n&&n.isSupported)(s=t.onLoaded)==null||s.call(t,n);else throw Error("");return n}catch(n){(r=t.onLoadError)==null||r.call(t,n)}}}async function C(o,t={}){var i,e,a;if(c(o)){(i=t.onLoadStart)==null||i.call(t);try{if(await M(o),!N(window.Hls))throw Error("");const s=window.Hls;return(e=t.onLoaded)==null||e.call(t,s),s}catch(s){(a=t.onLoadError)==null||a.call(t,s)}}}const P="https://cdn.jsdelivr.net",v=class v extends R{constructor(){super(...arguments),this.$$PROVIDER_TYPE="HLS",this.O=null,this.M=new _(this.video),this.N=`${P}/npm/hls.js@^1.0.0/dist/hls.min.js`}get ctor(){return this.O}get instance(){return this.M.instance}get type(){return"hls"}get canLiveSync(){return!0}get config(){return this.M.P}set config(t){this.M.P=t}get library(){return this.N}set library(t){this.N=t}preconnect(){c(this.N)&&L(this.N)}setup(t){super.setup(t),new D(this.N,t,i=>{this.O=i,this.M.setup(i,t),t.delegate.a("provider-setup",this);const e=f(t.$state.source);e&&this.loadSource(e)})}async loadSource(t,i){var e;c(t.src)&&(this.b.preload=i||"",(e=this.M.instance)==null||e.loadSource(t.src),this.s=t)}onInstance(t){const i=this.M.instance;return i&&t(i),this.M.Q.add(t),()=>this.M.Q.delete(t)}destroy(){this.M.R()}};v.supported=E();let T=v;export{T as HLSProvider};
